language: python
python: 3.7
jobs:
  include:
    - env: TOXENV=pre-commit
      script: tox
      install: pip install tox
    - stage: Create GitHub release
      before_install:
        - sudo apt-get update
        - sudo apt-get -y install jq
      install:
        - pip install yq
        - pip install tox
      before_deploy:
        - export AUTHOR_EMAIL="$(git log -1 $TRAVIS_COMMIT --pretty="%cE")"
        - export AUTHOR_NAME="$(git log -1 $TRAVIS_COMMIT --pretty="%aN")"
        - git config --local user.name $AUTHOR_NAME
        - git config --local user.email $AUTHOR_EMAIL
        - git tag $VERSION
      script:
        - tox
        - export VERSION="$(yq -r .metadata.template_version shell-definition.yaml)"
        - mv dist/dependencies.zip dist/cloudshell-vcenter-dependencies-package-$VERSION.zip
      deploy:
        provider: releases
        skip_cleanup: true
        draft: true
        api_key:
          secure: "MyxVKJOKU67p6jfaGY2+chKHebIseVh6/9hiMfla+V7PaRp+B2M//WB1xEGi7scD7yYkFSXzeeslrMmIStaGCXVZ07TldPcSPrIeTk7Bgjf/9uGHkHnN+dskQTwGj0ILgrOpc88dTtF+IFj1qEnXJp/p9/rWmTjENVW1w0cZt2IqSaUWNX6fMmlixQh3reSGQwEmffzSOoSmvGvZ1XH71q7jPWuEmrVa6TALdZ9LmcQcz5ISG4WVJDmZ14NAtHWAGImTc9O1EHOvu9L9P7nVZyPGcJ5YBuF5U5TXK869mLZanc2mfpdjHfI6whx0VbEAZbCfmFQDEVy7l8ig81sjnQxRAkd7x/6PG4mtskqDSppo1cL1mBwTpWs/UENpFGWNCAkTfokUP3SAJjO+R6FmH3FGNqFdJ6GJ6S/2GhZ+T4EjRlMS4dOS66KHqNesFExlCShMYNr3AMTJRuRGkEXaL9THqqGGnsKzj7GWHQLE2aTvaCUXsoqEyCX00Xsk2m0QbLd8FGsGySC6wi1EVAdRBjnMTIplEqXcu1AMk2jRJu+NQqtIkmdA0zp3v4I8shInxTYV9xlYh2v1QzkuiO2OCjIrjBypXpqEmbCDRaG4mcbA4Vt08p669SRnIi04p/qbLN0E6O5qbs4MCDIf7hwdezBtaTRRxUl/gQ0UOEDv098="
        file_glob: true
        file: dist/*.zip
        name: VMware vCenter Cloud Provider Shell 2G $GIT_TAG
        target_commitish: master
        on:
          branch: master
    - stage: Check version
      before_install:
        - sudo apt-get update
        - sudo apt-get -y install jq
      install:
        - pip install yq
        - git clone https://github.com/$TRAVIS_REPO_SLUG.git $TRAVIS_REPO_SLUG
        - cd $TRAVIS_REPO_SLUG
        - git checkout -qf $TRAVIS_PULL_REQUEST_BRANCH
      script: "! diff <(yq .metadata.template_version shell-definition.yaml) <(git show master:shell-definition.yaml > tmp.yaml && yq .metadata.template_version tmp.yaml)"

stages:
  - name: Check version
    if: branch = master AND type = pull_request
  - name: Test
  - name: Create GitHub release
    if: branch = master AND type != pull_request